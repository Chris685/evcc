template: kermi
products:
  - brand: Kermi
    description:
      generic: x-change
group: heating
# requirements:
#   evcc: ["sponsorship"]
params:
  - name: modbus
    choice: ["tcpip"]
    # id TWE 50, HK 51
  - name: tempsource
    type: choice
    choice: ["", "warmwater", "buffer"]
    description:
      de: "Temperaturquelle"
      en: "Temperature source"
render: |
  type: sgready
  getmode:
    source: map
    values:
      0: 3 # Off
      1: 1 # Eco
      2: 1 # Normal
      3: 2 # Comfort
      4: 1 # Benutzerdefiniert
    get:
      source: modbus
      {{- include "modbus" . | indent 4 }}
      register:
        address: 155
        type: holding
        encoding: uint16
  setmode:
    source: switch
    switch:
    - case: 1 # normal
      set:
      - source: const
        value: 2 # normal
        set:
          source: modbus
          {{- include "modbus" . | indent 8 }}
          register:
            address: 155
            type: writesingle
            encoding: uint16
    - case: 2 # boost
      set:
      - source: const
        value: 3 # comfort
        set:
          source: modbus
          {{- include "modbus" . | indent 8 }}
          register:
            address: 155
            type: writesingle
            encoding: uint16
    - case: 3 # dimm
      set:
      - source: const
        value: 1 # eco
        set:
          source: modbus
          {{- include "modbus" . | indent 8 }}
          register:
            address: 155
            type: writesingle
            encoding: uint16
  {{- if .tempsource }}
  temp:
    source: modbus
    {{- include "modbus" . | indent 2 }}
    register:
      address: {{ if eq .tempsource "warmwater" -}} 100 {{ else }} 1 {{- end }}
      type: holding
      encoding: int16
    scale: 0.1
  {{- end }}
